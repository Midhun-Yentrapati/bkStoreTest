<!-- book-detail.component.html -->
<div class="container-fluid" *ngIf="book; else loading">
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="container">
      <div class="row align-items-center min-vh-75">
        <div class="col-lg-5 mb-4 mb-lg-0">
          <!-- Image Gallery -->
          <div class="book-gallery">
            <!-- Main Image Display -->
            <div class="main-image-container">
              <img 
                [src]="getCurrentImage()" 
                [alt]="book.title" 
                class="book-hero-image"
                (click)="openImageModal()">
              <div class="image-overlay">
                <div class="gallery-actions">
                  <button 
                    class="nav-btn prev-btn"
                    (click)="previousImage()"
                    *ngIf="hasMultipleImages()"
                    [attr.aria-label]="'Previous image'">
                    <span class="material-icons">chevron_left</span>
                  </button>
                  <button 
                    class="zoom-btn"
                    (click)="openImageModal()"
                    [attr.aria-label]="'View full size'">
                    <span class="material-icons">zoom_in</span>
                  </button>
                  <button 
                    class="nav-btn next-btn"
                    (click)="nextImage()"
                    *ngIf="hasMultipleImages()"
                    [attr.aria-label]="'Next image'">
                    <span class="material-icons">chevron_right</span>
                  </button>
                </div>
              </div>
              
              <!-- Image Counter -->
              <div class="image-counter" *ngIf="hasMultipleImages()">
                {{ selectedImageIndex + 1 }} / {{ book.image_urls?.length || 0 }}
              </div>
            </div>
            
            <!-- Thumbnail Navigation -->
            <div class="thumbnail-container" *ngIf="hasMultipleImages()">
              <div class="thumbnails-wrapper">
                <button
                  *ngFor="let imageUrl of book.image_urls; let i = index"
                  class="thumbnail-btn"
                  [class.active]="i === selectedImageIndex"
                  (click)="selectImage(i)"
                  [attr.aria-label]="'View image ' + (i + 1)">
                  <img [src]="imageUrl" [alt]="book.title + ' - Image ' + (i + 1)">
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-7">
          <div class="book-details-content">
            <div class="mb-3">
              <span class="badge category-badge me-2" *ngFor="let category of book.categories">
                {{ category }}
              </span>
            </div>
            
            <h1 class="book-title">{{ book.title }}</h1>
            <p class="book-author">by <span class="author-name">{{ book.author }}</span></p>
            
            <div class="price-section mb-4">
              <span class="current-price">₹{{ book.price | number:'1.2-2' }}</span>
              <span class="price-currency">INR</span>
            </div>
            
            <p class="book-description">{{ book.description }}</p>
            
            <!-- Stock Information -->
            <div class="stock-info mb-4">
              <div class="stock-indicator" [ngClass]="{
                'stock-available': book.stock_actual > 5,
                'stock-low': book.stock_actual > 0 && book.stock_actual <= 5,
                'stock-out': book.stock_actual <= 0
              }">
                <span class="material-icons" [ngClass]="{
                  'text-success': book.stock_actual > 5,
                  'text-warning': book.stock_actual > 0 && book.stock_actual <= 5,
                  'text-danger': book.stock_actual <= 0
                }">
                  {{ book.stock_actual > 5 ? 'check_circle' : book.stock_actual > 0 ? 'warning' : 'cancel' }}
                </span>
                <span *ngIf="book.stock_actual > 5" class="stock-text">In Stock</span>
                <span *ngIf="book.stock_actual > 0 && book.stock_actual <= 5" class="stock-text">
                  Only {{ book.stock_actual }} left
                </span>
                <span *ngIf="book.stock_actual <= 0" class="stock-text">Out of Stock</span>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
              <button 
                class="btn btn-primary btn-cart" 
                (click)="addToCart()" 
                [disabled]="addingToCart || book.stock_actual <= 0">
                <span class="material-icons">shopping_cart</span>
                <span>{{ addingToCart ? 'Adding...' : 'Add to Cart' }}</span>
              </button>
              
              <ng-container *ngIf="isInWishlist$ | async as isInWishlist; else notInWishlist">
                <button 
                  class="btn btn-wishlist btn-wishlist-active" 
                  (click)="removeFromWishlist()" 
                  [disabled]="addingToWishlist">
                  <span class="material-icons">favorite</span>
                  <span>{{ addingToWishlist ? 'Updating...' : 'In Wishlist' }}</span>
                </button>
              </ng-container>
              <ng-template #notInWishlist>
                <button 
                  class="btn btn-wishlist" 
                  (click)="addToWishlist()" 
                  [disabled]="addingToWishlist">
                  <span class="material-icons">favorite_border</span>
                  <span>{{ addingToWishlist ? 'Updating...' : 'Add to Wishlist' }}</span>
                </button>
              </ng-template>
              
              <!-- Share Button -->
              <button 
                class="btn btn-share" 
                (click)="openShareModal()" 
                title="Share this book">
                <span class="material-icons">share</span>
                <span>Share</span>
              </button>
            </div>
            
            <!-- Features -->
            <div class="features-section mt-4">
              <div class="feature-item">
                <span class="material-icons">local_shipping</span>
                <span>Free shipping on orders over ₹500</span>
              </div>
              <div class="feature-item">
                <span class="material-icons">keyboard_return</span>
                <span>30-day return policy</span>
              </div>
              <div class="feature-item">
                <span class="material-icons">security</span>
                <span>Secure payment</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Book Reviews Section -->
  <div class="reviews-section bg-gray-50 py-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <h3 class="mb-4">Customer Reviews</h3>
          <app-review-list [reviews]="book.customerRatings || []" [bookTitle]="book.title"></app-review-list>
        </div>
        <div class="col-lg-4">
          <h4 class="mb-3">Write a Review</h4>
          <app-review-form 
            [bookTitle]="book.title"
            [existingRating]="0"
            [existingReview]="''"
            (reviewSubmit)="onReviewSubmit($event)"
            (cancel)="onReviewCancel()">
          </app-review-form>
        </div>
      </div>
    </div>
  </div>

  <!-- Similar Books Section -->
  <div class="similar-books-section">
    <div class="container">
      <div class="section-header text-center mb-5">
        <h2 class="section-title">You Might Also Like</h2>
        <p class="section-subtitle">Discover more books similar to {{ book.title }}</p>
      </div>
      
      <div class="row" *ngIf="!loadingSimilarBooks && similarBooks.length > 0">
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4" *ngFor="let similarBook of similarBooks">
          <div class="similar-book-card" (click)="navigateToBook(similarBook.id)">
            <div class="similar-book-image">
              <img [src]="similarBook.image_urls?.[0] || 'https://placehold.co/150x200?text=No+Image'" [alt]="similarBook.title">
              <div class="book-overlay">
                <span class="material-icons">visibility</span>
              </div>
            </div>
            <div class="similar-book-info">
              <h6 class="similar-book-title">{{ similarBook.title }}</h6>
              <p class="similar-book-author">{{ similarBook.author }}</p>
              <div class="similar-book-price">₹{{ similarBook.price | number:'1.2-2' }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="text-center py-5" *ngIf="loadingSimilarBooks">
        <div class="spinner" role="status">
          <span class="visually-hidden">Loading similar books...</span>
        </div>
      </div>
      
      <div class="text-center py-5" *ngIf="!loadingSimilarBooks && similarBooks.length === 0">
        <p class="text-muted">No similar books found.</p>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="image-modal" *ngIf="showImageModal" (click)="closeImageModal()">
  <div class="modal-backdrop"></div>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeImageModal()" aria-label="Close">
      <span class="material-icons">close</span>
    </button>
    
    <div class="modal-image-container">
      <img [src]="getCurrentImage()" [alt]="book.title" class="modal-image">
      
      <button 
        class="modal-nav prev"
        (click)="previousImage()"
        *ngIf="hasMultipleImages()"
        aria-label="Previous image">
        <span class="material-icons">chevron_left</span>
      </button>
      
      <button 
        class="modal-nav next"
        (click)="nextImage()"
        *ngIf="hasMultipleImages()"
        aria-label="Next image">
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
    
    <div class="modal-footer" *ngIf="hasMultipleImages()">
      <div class="modal-counter">
        {{ selectedImageIndex + 1 }} / {{ book.image_urls?.length || 0 }}
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<app-share-modal 
  [book]="book" 
  [isOpen]="showShareModal" 
  (closeModal)="closeShareModal()" 
  (shareSuccess)="onShareSuccess($event)">
</app-share-modal>

<ng-template #loading>
  <div class="loading-container">
    <div class="text-center">
      <div class="spinner" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 class="text-muted">Loading book details...</h5>
    </div>
  </div>
</ng-template>
