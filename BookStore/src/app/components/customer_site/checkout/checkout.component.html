<div class="main-content-container">
  <!-- Progress Steps -->
  <div class="checkout-steps fade-in">
    <div *ngFor="let step of steps" class="step" [ngClass]="getStepClass(step)">
      <div class="step-number">{{ step.number }}</div>
      <div class="step-title">{{ step.title }}</div>
    </div>
  </div>

  <div class="row gap-4">
    <!-- Left Panel - Main Content -->
    <div class="col-lg-8">
      <!-- Section 1: LOGIN -->
      <div class="login-section card card-elevated">
        <div class="login-header">
          <div class="login-status">
            <span class="step-number step-completed">1</span>
            <h5 class="m-0">LOGIN</h5>
            <span class="material-icons text-success">check_circle</span>
          </div>
        </div>
        <div class="login-content p-3">
          <div class="d-flex align-items-center" *ngIf="getCurrentUser() as user">
            <div class="user-avatar me-3">
              <span class="material-icons">account_circle</span>
            </div>
            <div>
              <p class="mb-1 font-semibold">{{ user.fullName }}</p>
              <p class="mb-0 text-muted">{{ user.email }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2: DELIVERY ADDRESS -->
      <div class="address-section">
        <div class="address-header">
          <h5 class="mb-0">2 DELIVERY ADDRESS</h5>
        </div>
        <div class="address-content">
          <!-- Loading State -->
          <div *ngIf="isLoadingAddresses" class="loading-container">
            <div class="spinner"></div>
            <span class="loading-text">Loading addresses...</span>
          </div>

          <!-- Addresses List -->
          <div *ngIf="!isLoadingAddresses && addresses.length > 0">
            <div *ngFor="let address of addresses; trackBy: trackByAddressId" 
                 class="address-card d-flex"
                 [class.selected]="selectedAddress?.id === address.id"
                 (click)="selectAddress(address)">
              
              <input class="address-radio" 
                     type="radio" 
                     [id]="'address-' + address.id" 
                     [checked]="selectedAddress?.id === address.id"
                     (change)="selectAddress(address)">
              
              <div class="address-info flex-grow-1">
                <div class="address-name">
                  {{ address.name }}
                  <span class="address-type-badge">{{ address.addressType }}</span>
                  <span *ngIf="address.isDefault" class="badge badge-primary ms-2">Default</span>
                </div>
                
                <div class="address-phone">{{ address.phone }}</div>
                
                <div class="address-details">
                  {{ address.address }}, {{ address.locality }}<br>
                  {{ address.city }}, {{ address.state }} - {{ address.pincode }}
                  <span *ngIf="address.landmark"><br>Landmark: {{ address.landmark }}</span>
                </div>
              </div>
              
              <div class="address-actions">
                <button class="btn btn-sm btn-outline address-btn" 
                        (click)="editAddress(address); $event.stopPropagation()">
                  <span class="material-icons">edit</span>
                  Edit
                </button>
                <button class="btn btn-sm btn-outline address-btn" 
                        (click)="setAsDefaultAddress(address); $event.stopPropagation()"
                        *ngIf="!address.isDefault">
                  <span class="material-icons">star_border</span>
                  Set Default
                </button>
                <button class="btn btn-sm btn-outline text-error address-btn" 
                        (click)="deleteAddress(address); $event.stopPropagation()"
                        *ngIf="addresses.length > 1">
                  <span class="material-icons">delete</span>
                  Delete
                </button>
              </div>
            </div>
            
            <div class="mt-3" *ngIf="selectedAddress">
              <button class="btn btn-primary btn-lg" (click)="deliverHere()">
                <span class="material-icons">local_shipping</span>
                DELIVER HERE
              </button>
            </div>
          </div>

          <!-- No Addresses State -->
          <div *ngIf="!isLoadingAddresses && addresses.length === 0" class="empty-state">
            <span class="material-icons">location_off</span>
            <h5>No addresses found</h5>
            <p class="text-muted">Please add a delivery address to continue.</p>
          </div>

          <!-- Add New Address Button -->
          <div class="mt-3">
            <button class="btn btn-outline" (click)="addNewAddress()">
              <span class="material-icons">add</span>
              Add a new address
            </button>
          </div>
        </div>
      </div>

      <!-- Section 3: ORDER SUMMARY -->
      <div class="order-summary" *ngIf="currentStep >= 3">
        <div class="summary-header">
          <h5 class="mb-0">3 ORDER SUMMARY</h5>
        </div>
        <div class="summary-content">
          <div *ngFor="let item of cartItems; trackBy: trackByItemId" class="order-item">
            <div class="item-details">
                                             <div class="item-title">{{ item.book.title }}</div>
                   <div class="item-author">by {{ item.book.author }}</div>
            </div>
            <div class="item-pricing">
              <span class="item-quantity">Qty: {{ item.quantity }}</span>
                               <span class="item-price">₹{{ (item.book.price * item.quantity) | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Price Details -->
    <div class="col-lg-4">
      <div class="price-details">
        <div class="price-header">
          <h5 class="mb-0">PRICE DETAILS</h5>
        </div>
        <div class="price-content">
          <div *ngIf="orderSummary; else loadingSummary">
            <div class="price-row">
              <span>Price ({{ cartItems.length }} item{{ cartItems.length > 1 ? 's' : '' }})</span>
                                <span>₹{{ orderSummary.totalAmount | number:'1.2-2' }}</span>
            </div>
            <div class="price-row">
              <span>Taxes (GST)</span>
                                <span>₹{{ orderSummary.taxes | number:'1.2-2' }}</span>
            </div>
            <div class="price-row">
              <span>Shipping Fee</span>
              <span *ngIf="orderSummary.shippingFee === 0" class="price-savings">
                FREE
              </span>
              <span *ngIf="orderSummary.shippingFee > 0">
                ₹{{ orderSummary.shippingFee | number:'1.2-2' }}
              </span>
            </div>
            <div class="price-row total">
              <strong>Total Payable</strong>
              <strong class="text-primary">₹{{ orderSummary.totalPayable | number:'1.2-2' }}</strong>
            </div>
          </div>

          <!-- Coupon Section -->
          <app-coupon-input 
            [orderAmount]="orderSummary?.totalAmount || 0"
            (couponApplied)="onCouponApplied($event)"
            (couponRemoved)="onCouponRemoved()"></app-coupon-input>

          <ng-template #loadingSummary>
            <div class="loading-container">
              <div class="spinner"></div>
              <span class="loading-text">Calculating...</span>
            </div>
          </ng-template>

          <!-- Security Info -->
          <div class="security-info">
            <span class="material-icons">security</span>
            <span class="security-text">Safe and Secure Payments. Easy returns. 100% Authentic products.</span>
          </div>

          <!-- Payment Button -->
          <div *ngIf="canProceedToPayment()">
            <button class="btn btn-primary w-100" (click)="proceedToPayment()">
              <span class="material-icons">payment</span>
              PROCEED TO PAYMENT
            </button>
          </div>
        </div>
      </div>

      <!-- Terms -->
      <div class="card mt-3">
        <div class="card-body">
          <div class="terms-text">
            By continuing with the order, you confirm that you are above 18 years of age, and you agree to the 
            <a href="#" class="text-primary">Terms of Use</a> and <a href="#" class="text-primary">Privacy Policy</a>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="row mt-4">
    <div class="col-12">
      <button class="btn btn-secondary" (click)="goBack()">
        <span class="material-icons">arrow_back</span>
        Back to Cart
      </button>
    </div>
  </div>
</div>
  